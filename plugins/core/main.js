!function(e){"function"==typeof define&&define.amd?define(e):e()}((function(){"use strict";const e=new Epml({type:"WINDOW",source:window.parent});new Epml({type:"PROXY",source:{proxy:e,target:"visible-plugin",id:"core-plugin"}});let t,o,n,s,a,r=0,d=!1,i=!1,l=!1,c=!0,p=!1,u=0,m=!1,g=!1,w=!1;e.subscribe("logged_in",e=>{w="true"===e});const S=async()=>{const t=await e.request("apiCall",{url:"/admin/info"});e.request("updateNodeInfo",t)};let h,C=0;const T=()=>{t.close(),d=!0,n.close(),p=!0},O=t=>{e.request("updateBlockInfo",t)},f=async t=>{e.request("updateNodeStatus",t)},N=e=>{0==e.node||1==e.node?E():void 0!==n&&(n.close(),p=!0)},b=()=>{let n,s=window.parent.reduxStore.getState().app.nodeConfig.knownNodes[window.parent.reduxStore.getState().app.nodeConfig.node],i=s.domain+":"+s.port;n="https:"===window.parent.location.protocol?`wss://${i}/websockets/blocks`:`ws://${i}/websockets/blocks`;const p=new WebSocket(n);p.onopen=e=>{console.log("[SOCKET-BLOCKS]: Connected."),d=!1,t=p,r+=1},p.onmessage=t=>{O(JSON.parse(t.data)),w&&(async t=>{let o={names:await e.request("apiCall",{url:"/names/address/"+t}),addressInfo:await e.request("apiCall",{url:"/addresses/"+t})};!0!==window.parent._.isEqual(a,o)&&(e.request("setAccountInfo",o),a=o)})(window.parent.reduxStore.getState().app.selectedAddress.address)},p.onclose=()=>{console.log("[SOCKET-BLOCKS]: CLOSED"),O({}),c=!0,clearInterval(o),!1===d&&r<=52&&(r<=52?(l=!0,setTimeout(k,1e4),r+=1):l=!1)},p.onerror=e=>{console.log("[SOCKET-BLOCKS]: "+e.type),c=!0,O({})},c&&e.request("apiCall",{url:"/blocks/last"}).then(e=>{O(e),c=!1})},k=()=>{i?(i=!1,b(),o=setTimeout(k,295e3)):l?(l=!1,clearTimeout(o),b(),i=!0,o=setTimeout(k,295e3)):(t.send("non-integer ping"),o=setTimeout(k,295e3))},q=()=>{let e,t=window.parent.reduxStore.getState().app.nodeConfig.knownNodes[window.parent.reduxStore.getState().app.nodeConfig.node],o=t.domain+":"+t.port;e="https:"===window.parent.location.protocol?`wss://${o}/websockets/admin/status`:`ws://${o}/websockets/admin/status`;const a=new WebSocket(e);a.onopen=e=>{console.log("[SOCKET-NODE-STATUS]: Connected."),p=!1,n=a,u+=1},a.onmessage=e=>{f(JSON.parse(e.data))},a.onclose=()=>{console.log("[SOCKET-NODE-STATUS]: CLOSED"),f({}),clearInterval(s),!1===p&&u<=52&&(u<=52?(m=!0,setTimeout(E,1e4),u+=1):m=!1)},a.onerror=e=>{console.log("[SOCKET-NODE-STATUS]: "+e.type),f({})}},E=()=>{g?(clearTimeout(s),q(),g=!1,s=setTimeout(E,295e3)):m?(m=!1,clearTimeout(s),q(),s=setTimeout(E,295e3)):(n.send("non-integer ping"),s=setTimeout(E,295e3))},x=e=>[...e.groups.map(e=>0===e.groupId?{groupId:e.groupId,url:"group/"+e.groupId,groupName:"Qortal General Chat",sender:e.sender,senderName:e.senderName,timestamp:void 0===e.timestamp?1:e.timestamp}:{...e,url:"group/"+e.groupId}),...e.direct.map(e=>({...e,url:"direct/"+e.address}))];let y=0;const I=t=>{let o=window.parent.reduxStore.getState().app.selectedAddress.address.substr(0,10)+"_chat-heads";try{let n=localStorage.getItem(o);null===n?e.request("setLocalStorage",{key:o,dataObj:t}).then(o=>{e.request("setChatHeads",t).then(e=>{})}):(e.request("setLocalStorage",{key:o,dataObj:t}).then(o=>{e.request("setChatHeads",t).then(e=>{})}),y>=1?((t,o)=>{let n=JSON.parse(o);if(!0!==window.parent._.isEqual(n,t)){let o=x(n);x(t).filter(e=>!o.some(t=>e.timestamp===t.timestamp)).forEach(t=>{t.sender!==window.parent.reduxStore.getState().app.selectedAddress.address&&void 0!==t.sender&&e.request("showNotification",t)})}})(t,n):y+=1)}catch(e){console.error(e)}};let _,v,$=0,A=!1,K=!1,D=!1,L=!1;e.subscribe("logged_in",async t=>{const o=()=>{let t,o=window.parent.reduxStore.getState().app.nodeConfig.knownNodes[window.parent.reduxStore.getState().app.nodeConfig.node],s=o.domain+":"+o.port;t="https:"===window.parent.location.protocol?`wss://${s}/websockets/chat/active/${window.parent.reduxStore.getState().app.selectedAddress.address}`:`ws://${s}/websockets/chat/active/${window.parent.reduxStore.getState().app.selectedAddress.address}`;const a=new WebSocket(t);a.onopen=()=>{console.log("[SOCKET]: Connected."),_=a,$+=1,L=!0},a.onmessage=e=>{I(JSON.parse(e.data))},a.onclose=()=>{console.log("[SOCKET]: CLOSED"),clearInterval(v),!1===A&&$<=52&&($<=52?(e.request("showSnackBar","Connection to the Qortal Core was lost, is your Core running ?"),D=!0,setTimeout(n,1e4),$+=1):e.request("showSnackBar","Cannot connect to the Qortal Core, restart UI and Core!"))},a.onerror=e=>{console.log("[SOCKET]: "+e.type)}},n=()=>{!0===window.parent.reduxStore.getState().app.loggedIn?K?D?(D=!1,clearTimeout(v),o(),K=!0,v=setTimeout(n,295e3)):L&&(_.send("ping"),v=setTimeout(n,295e3)):(o(),K=!0,v=setTimeout(n,295e3)):K&&!A&&(A=!0,_.close(),clearTimeout(v),K=!1,L=!1)};"true"===t?((async t=>{let o={names:await e.request("apiCall",{url:"/names/address/"+t}),addressInfo:await e.request("apiCall",{url:"/addresses/"+t})};e.request("setAccountInfo",o)})(window.parent.reduxStore.getState().app.selectedAddress.address),n()):(K&&(A=!0,_.close(),clearTimeout(v),K=!1,L=!1),y=0)}),e.ready().then(()=>{e.subscribe("node_config",e=>{if(0===C){let o=JSON.parse(e);h={node:o.node,knownNodes:o.knownNodes},C+=1,g=!0,i=!0,void 0!==t&&T(),void 0!==n&&T(),N(h),k(),S()}let o=JSON.parse(e),s={node:o.node,knownNodes:o.knownNodes};!0!==window.parent._.isEqual(h,s)&&(h=s,g=!0,i=!0,void 0!==t&&T(),void 0!==n&&T(),N(s),k(),S())})}),e.imReady();let R,J={},B=!1;const M=()=>{if(!R||!J.coin)return;const e=J.coin.node.airdrop;console.log("PING_AIRDROP_SERVER_NODE:  ==> ",e);const t=`${e.protocol}://${e.domain}:${e.port}${e.dhcpUrl}${R}`;fetch(t).then(e=>{})};e.ready().then(()=>{let t=[{url:"wallet",domain:"core",page:"wallet/index.html",title:"Wallet",icon:"account_balance_wallet",menus:[],parent:!1},{url:"send-money",domain:"core",page:"send-money/index.html",title:"Send Money",icon:"send",menus:[],parent:!1},{url:"reward-share",domain:"core",page:"reward-share/index.html",title:"Reward Share",icon:"call_split",menus:[],parent:!1},{url:"name-registration",domain:"core",page:"name-registration/index.html",title:"Name Registration",icon:"assignment_ind",menus:[],parent:!1},{url:"messaging",domain:"core",page:"messaging/index.html",title:"Messaging",icon:"message",menus:[{url:"chain-messaging",domain:"core",page:"messaging/chain-messaging/index.html",title:"Chain Messaging",icon:"toc",menus:[],parent:!1},{url:"q-chat",domain:"core",page:"messaging/q-chat/index.html",title:"Q-Chat",icon:"toc",menus:[],parent:!1}],parent:!1},{url:"group-management",domain:"core",page:"group-management/index.html",title:"Group Management",icon:"group",menus:[],parent:!1}];const o=t=>{e.request("registerUrl",t)};e.subscribe("config",e=>{if(J=JSON.parse(e),M(),!B&&J.user.knownNodes[J.user.node].enableManagement){B=!0;let e={url:"node-management",domain:"core",page:"node-management/index.html",title:"Node Management",icon:"cloud",menus:[],parent:!1},n=[...t,e];o(n)}else o(t)}),e.subscribe("selected_address",e=>{R=e.address,M()})}),setInterval(M,1e4)}));
